<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>DENUE ‚Ä¢ B√∫squeda en mapa</title>
    <link rel="icon" type="image/svg+xml"
          href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0%200%20100%20100'%3E%3Ctext y='.9em' font-size='90'%3Eüìç%3C/text%3E%3C/svg%3E">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        :root {
            --panel-bg: #ffffff;
            --panel-shadow: 0 6px 24px rgba(0, 0, 0, .12);
            --accent: #2a7;
        }

        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100%;
        }

        .panel {
            position: absolute;
            z-index: 1000;
            top: 12px;
            left: 12px;
            background: var(--panel-bg);
            padding: 12px;
            border-radius: 10px;
            box-shadow: var(--panel-shadow);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
            min-width: 320px;
            max-width: 380px;
        }

        .status {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .row>label {
            font-size: 13px;
            color: #333;
        }

        .row>input[type="text"] {
            grid-column: span 2;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .row .value {
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            color: #111;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 6px;
        }

        button {
            padding: 10px 12px;
            border: 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: #111;
            color: #fff;
        }

        button.secondary {
            background: #e9ecef;
            color: #111;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .hint {
            font-size: 12px;
            color: #555;
            margin-top: 6px;
        }

        .badge {
            position: absolute;
            z-index: 1000;
            bottom: 12px;
            left: 12px;
            background: var(--panel-bg);
            padding: 8px 10px;
            border-radius: 999px;
            box-shadow: var(--panel-shadow);
            font-size: 13px;
        }

        :root {
            --center-color: #ff3b30;
        }

        .center-icon {
            position: relative;
            width: 18px;
            height: 18px;
            background: var(--center-color);
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 2px var(--center-color);
        }

        .center-icon::after {
            content: "";
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            border: 2px solid var(--center-color);
            opacity: .3;
            animation: pulse 1.5s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.9);
                opacity: .5;
            }

            70% {
                transform: scale(1.15);
                opacity: 0;
            }

            100% {
                transform: scale(0.9);
                opacity: 0;
            }
        }

        #loading{
            position: fixed; inset: 0; display: none; place-items: center;
            background: rgba(255,255,255,.7); backdrop-filter: blur(2px); z-index: 2000;
        }
        #loading.show{ display: grid; }

        .loading-box{
            background: #fff; padding: 16px 18px; border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,.15); text-align: center;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
        }
        .spinner{
            width: 40px; height: 40px; border-radius: 50%;
            border: 4px solid #e5e5e5; border-top-color: #111;
            animation: spin 1s linear infinite; margin: 0 auto 8px;
        }
        @keyframes spin{ to{ transform: rotate(360deg); } }
        .loading-text{ font-weight: 600; }
    </style>
</head>

<body>
<div class="panel" id="panel">
    <div class="row">
        <label for="q">¬øQu√© buscamos?</label>
        <span></span>
        <input id="q" type="text" placeholder="hospital, panader√≠a, ferreter√≠a..." value="" />
    </div>

    <div class="row">
        <label for="radius">Radio (m)</label>
        <span class="value"><span id="radiusValue">1000</span> m</span>
        <input id="radius" type="range" min="50" max="5000" step="50" value="1000" style="grid-column: span 2;">
    </div>

    <div class="actions">
        <button id="locateBtn" type="button" title="Usar mi ubicaci√≥n">üìç Mi ubicaci√≥n</button>
        <button id="clearBtn" class="secondary" type="button">Limpiar</button>
        <button id="searchBtn" style="grid-column: span 2;" type="button">Buscar</button>
    </div>

    <div class="hint">1) Haz <b>clic en el mapa</b> para elegir el centro. 2) Ajusta el <b>radio</b>. 3) Presiona
        <b>Buscar</b>.
    </div>
</div>

<div id="map"></div>

<div id="loading">
    <div class="loading-box">
        <div class="spinner"></div>
        <div id="loadingText" class="loading-text">Cargando‚Ä¶</div>
    </div>
</div>

<div class="badge"><span id="status" class="status">Listo para buscar</span></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // Change to your backend route
    const API_BASE = "https://denue-api.onrender.com";
    
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');

    // UI elements
    const qInput = document.getElementById('q');
    const radiusInput = document.getElementById('radius');
    const radiusValue = document.getElementById('radiusValue');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const locateBtn = document.getElementById('locateBtn');
    const statusEl = document.getElementById('status');
    const CENTER_COLOR = (getComputedStyle(document.documentElement)
        .getPropertyValue('--center-color').trim()) || '#2a7';
    const centerIcon = L.divIcon({
        className: 'center-icon',
        iconSize: [18, 18],
        iconAnchor: [9, 9]
    });

    radiusInput.addEventListener('input', () => {
        radiusValue.textContent = radiusInput.value;
        if (searchCircle) {
            searchCircle.setRadius(+radiusInput.value);
        }
    });

    // Map configuration
    const map = L.map('map', { zoomControl: false, zoomSnap: 0.5, zoomDelta: 0.5 })
        .setView([22.1565, -100.985], 13);

    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let centerMarker = null;
    let searchCircle = null;
    const resultsLayer = L.layerGroup().addTo(map);

    // Click to define center
    map.on('click', (e) => {
        setCenter(e.latlng);
    });

    function setCenter(latlng) {
        if (!centerMarker) {
            centerMarker = L.marker(latlng, { draggable: true, title: 'Centro de b√∫squeda', icon: centerIcon}).addTo(map);
            centerMarker.on('drag', (ev) => {
                const pos = ev.target.getLatLng();
                if (searchCircle) searchCircle.setLatLng(pos);
            });
        } else {
            centerMarker.setLatLng(latlng);
        }
        if (!searchCircle) {
            searchCircle = L.circle(latlng, {
                radius: +radiusInput.value,
                color: CENTER_COLOR, fillColor: CENTER_COLOR, fillOpacity: 0.07, weight: 2
            }).addTo(map);
        } else {
            searchCircle.setLatLng(latlng);
        }
        statusEl.textContent = `Centro: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)} ‚Ä¢ Radio: ${radiusInput.value} m`;
    }

    // Location usage
    locateBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert("Tu navegador no soporta geolocalizaci√≥n.");
            return;
        }
        navigator.geolocation.getCurrentPosition((pos) => {
            const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            setCenter(latlng);
            map.setView(latlng, 15);
        }, (err) => {
            console.warn(err);
            alert("No se pudo obtener tu ubicaci√≥n.");
        }, { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 });
    });

    // Clear map
    clearBtn.addEventListener('click', () => {
        resultsLayer.clearLayers();
        if (centerMarker) { map.removeLayer(centerMarker); centerMarker = null; }
        if (searchCircle) { map.removeLayer(searchCircle); searchCircle = null; }
        statusEl.textContent = 'Listo para buscar';
    });

    // Search button
    searchBtn.addEventListener('click', async () => {
        if (!centerMarker || !searchCircle) {
            alert("Primero selecciona el centro con un clic en el mapa (o usa Mi ubicaci√≥n).");
            return;
        }
        const center = centerMarker.getLatLng();
        const radius = +radiusInput.value;
        const q = qInput.value.trim();
        if (!q) {
            alert("Escribe qu√© quieres buscar (ej. hosptial).");
            return;
        }

        // DENUE limit: 5000 m
        if (radius < 1 || radius > 5000) {
            alert("El radio debe estar entre 1 y 5000 metros (l√≠mite de la API DENUE).");
            return;
        }

        const url = `${API_BASE}/denue/search?query=${encodeURIComponent(q)}&lat=${center.lat}&lng=${center.lng}&radius=${radius}`;

        let slowTimer;
        let controller;
        let timeoutId;
        
        try {
            searchBtn.disabled = true;
            searchBtn.textContent = 'Buscando...';
            statusEl.textContent = 'Consultando DENUE...';

            loadingText.textContent = 'Cargando‚Ä¶';
            loading.classList.add('show');
            slowTimer = setTimeout(() => {
                loadingText.textContent = 'No cierres la pagina‚Ä¶';
            }, 1000);

            controller = new AbortController();
            timeoutId = setTimeout(() => controller.abort(), 15000);

            const res = await fetch(url, { signal: controller.signal });
            if (!res.ok) {
                resultsLayer.clearLayers();
                if (searchCircle) {
                    map.fitBounds(searchCircle.getBounds(), { padding: [24,24] });
                } else {
                    map.setView(center, 15);
                }
                statusEl.textContent = `No se encontraron datos para ‚Äú${q}‚Äù en ${radius} m.`;
                return;
            }
            const data = await res.json(); // places

            resultsLayer.clearLayers();

            const bounds = [];
            data.forEach(p => {
                const la = parseFloat(p.Latitud ?? (p.latitud ?? 'NaN'));
                const lo = parseFloat(p.Longitud ?? (p.longitud ?? 'NaN'));
                if (Number.isFinite(la) && Number.isFinite(lo)) {
                    const m = L.marker([la, lo]).addTo(resultsLayer);
                    const html = `
                    <strong>${p.Nombre ?? 'Sin nombre'}</strong><br/>
                    ${p.Calle ?? ''} ${p.Num_Exterior ?? ''}, ${p.Colonia ?? ''}<br/>
                    ${p.Ubicacion ?? ''}<br/>
                    <small>Tel: ${p.Telefono || '‚Äî'}</small>
                    ${p.DistanceMeters ? `<br/><small>Distancia: ${Math.round(p.DistanceMeters)} m</small>` : ''}
                `;
                    m.bindPopup(html);
                    bounds.push([la, lo]);
                }
            });

            // Adjust view
            if (bounds.length) {
                const all = L.latLngBounds(bounds);
                all.extend(searchCircle.getBounds());
                map.fitBounds(all, { padding: [24,24] });
                statusEl.textContent = `Resultados: ${bounds.length} ‚Ä¢ Centro ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)} ‚Ä¢ Radio ${radius} m`;
            } else {
                if (searchCircle) {
                    map.fitBounds(searchCircle.getBounds(), { padding: [24,24] });
                } else {
                    map.setView(center, 15);
                }
                statusEl.textContent = `No se encontraron datos para ‚Äú${q}‚Äù en ${radius} m.`;
            }
        } catch (err) {
            if (err && err.name === 'AbortError') {
                resultsLayer.clearLayers();
                if (searchCircle) {
                    map.fitBounds(searchCircle.getBounds(), { padding: [24,24] });
                } else {
                    map.setView(center, 15);
                }
                statusEl.textContent = `No se encontraron datos para ‚Äú${q}‚Äù en ${radius} m.`;
            } else {
                console.error("ERROR", err);
                alert("Error al consultar la API. Revisa la consola y que tu backend est√© corriendo.");
                statusEl.textContent = 'Error al consultar';
            }
        } finally {
            if (slowTimer) clearTimeout(slowTimer);
            if (timeoutId) clearTimeout(timeoutId);
            loading.classList.remove('show');
            loadingText.textContent = 'Cargando‚Ä¶';
            searchBtn.disabled = false;
            searchBtn.textContent = 'Buscar';
        }
    });
</script>
</body>

</html>